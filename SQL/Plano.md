üöÄ Plano Definitivo: Dashboard de Promotores com Fluxo de Aprova√ß√£o NativoEste guia cont√©m todos os passos necess√°rios para implementar o sistema de visitas com trava de seguran√ßa, pesquisa inteligente e modera√ß√£o por e-mail.1. Banco de Dados (SQL Editor do Supabase)Execute este bloco para criar a estrutura necess√°ria. Ele cria a tabela de visitas, configura a seguran√ßa e ativa a busca autom√°tica do e-mail do coordenador.-- 1. Tabela de Visitas
CREATE TABLE IF NOT EXISTS public.visitas (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    id_promotor uuid REFERENCES auth.users(id) ON DELETE CASCADE, 
    id_cliente bigint, 
    data_visita timestamp with time zone DEFAULT now(),
    checkout_at timestamp with time zone,
    latitude double precision,
    longitude double precision,
    status text DEFAULT 'pendente', -- pendente, aprovado, rejeitado
    respostas jsonb,
    observacao text,
    coordenador_email text 
);

-- 2. Seguran√ßa (RLS)
ALTER TABLE public.visitas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Promotores inserem suas visitas" ON public.visitas FOR INSERT TO authenticated WITH CHECK (auth.uid() = id_promotor);
CREATE POLICY "Promotores veem suas visitas" ON public.visitas FOR ALL TO authenticated USING (auth.uid() = id_promotor);
CREATE POLICY "Servi√ßo tem acesso total" ON public.visitas FOR ALL TO service_role USING (true);

-- 3. Prote√ß√£o da API Key (Tabela data_metadata)
ALTER TABLE public.data_metadata ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Apenas servidor l√™ chaves" ON public.data_metadata FOR SELECT TO service_role USING (true);

-- 4. Fun√ß√£o: Auto-preencher e-mail do coordenador
CREATE OR REPLACE FUNCTION public.preencher_email_coordenador()
RETURNS TRIGGER AS $$
BEGIN
  -- Busca o email na tabela profiles (ajuste se a coluna tiver outro nome)
  NEW.coordenador_email := (SELECT email FROM profiles WHERE eh_coordenador = true LIMIT 1);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_auto_email_coordenador
BEFORE INSERT ON public.visitas
FOR EACH ROW EXECUTE FUNCTION public.preencher_email_coordenador();
2. Interface (index.html)Adicione estes modais logo antes de fechar a tag </body>. Eles s√£o as janelas que aparecer√£o para o promotor.<!-- MODAL DE PESQUISA -->
<div id="modal-relatorio" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Relat√≥rio de Visita</h3>
            <span class="close-modal" onclick="fecharModalRelatorio()">&times;</span>
        </div>
        <form id="form-visita">
            <input type="hidden" id="visita-atual-id" name="visita_id">
            <p class="hint-text">üí° Carregamos os dados da √∫ltima visita. Mude apenas o necess√°rio.</p>

            <div class="form-group">
                <label>Estado da G√¥ndola:</label>
                <select name="estado_gondola" required>
                    <option value="Excelente">Excelente</option>
                    <option value="Boa">Boa</option>
                    <option value="Bagun√ßada">Bagun√ßada</option>
                    <option value="Critica">Cr√≠tica</option>
                </select>
            </div>

            <div class="section-title">Elma Chips</div>
            <div class="form-group">
                <label>Tipo de Rack:</label>
                <select name="tipo_rack">
                    <option value="Padrao">Padr√£o</option>
                    <option value="Display">Display</option>
                    <option value="ClipStrip">Clip Strip</option>
                    <option value="Nenhum">Nenhum</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tem se√ß√£o dedicada?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_secao" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_secao" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea name="observacoes" rows="2"></textarea>
            </div>

            <button type="submit" class="btn-primary full-width">Salvar e Enviar</button>
        </form>
    </div>
</div>

<!-- MODAL DE INFO DO CLIENTE -->
<div id="modal-info-cliente" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Dados do Cliente</h3>
            <span class="close-modal" onclick="fecharModalInfo()">&times;</span>
        </div>
        <div id="info-cliente-conteudo"></div>
        <button class="btn-secondary full-width" onclick="fecharModalInfo()" style="margin-top:10px;">Fechar</button>
    </div>
</div>
3. L√≥gica do App (app.js)Esta √© a parte principal que controla a trava de check-in e o preenchimento autom√°tico.let visitaAbertaId = null;
let clienteEmVisitaId = null;

// 1. Verifica estado ao carregar
async function verificarEstadoVisita() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data } = await supabase
        .from('visitas')
        .select('id, id_cliente')
        .eq('id_promotor', user.id)
        .is('checkout_at', null)
        .maybeSingle();

    if (data) {
        visitaAbertaId = data.id;
        clienteEmVisitaId = data.id_cliente;
    }
    renderClientes(meusClientesGlobais);
}

// 2. Renderiza√ß√£o dos Cards no Roteiro
function renderClientes(lista) {
    const container = document.getElementById('lista-roteiro');
    container.innerHTML = '';

    lista.forEach(cliente => {
        const estaNeste = (visitaAbertaId && clienteEmVisitaId === cliente.id);
        const estaEmOutro = (visitaAbertaId && clienteEmVisitaId !== cliente.id);

        const card = document.createElement('div');
        card.className = 'card-cliente';
        card.innerHTML = `
            <h3>${cliente.nome}</h3>
            <div class="cliente-actions">
                ${estaNeste ? 
                    `<button class="btn-checkout" onclick="fazerCheckOut(${cliente.id})">üõë Check-out</button>
                     <button class="btn-survey" onclick="abrirPesquisa()">üìù Pesquisa</button>` :
                    `<button class="btn-checkin ${estaEmOutro ? 'disabled' : ''}" 
                        onclick="${estaEmOutro ? "alert('Finalize a outra visita!')" : `fazerCheckIn(${cliente.id})`}">
                        üìç Check-in
                    </button>`
                }
                <button class="btn-info" onclick="verInfo(${cliente.id})">‚ÑπÔ∏è Info</button>
            </div>
        `;
        container.appendChild(card);
    });
}

// 3. Pesquisa com Mem√≥ria
window.abrirPesquisa = async function() {
    const form = document.getElementById('form-visita');
    form.reset();

    // Busca √∫ltima resposta deste cliente
    const { data } = await supabase
        .from('visitas')
        .select('respostas')
        .eq('id_cliente', clienteEmVisitaId)
        .not('respostas', 'is', null)
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (data?.respostas) {
        Object.keys(data.respostas).forEach(key => {
            const campo = form.elements[key];
            if (campo) {
                if (campo instanceof RadioNodeList) campo.value = data.respostas[key];
                else campo.value = data.respostas[key];
            }
        });
    }

    document.getElementById('visita-atual-id').value = visitaAbertaId;
    document.getElementById('modal-relatorio').style.display = 'flex';
}
4. Fun√ß√µes de Bordas (Edge Functions)Aqui est√£o os c√≥digos limpos para as tr√™s fun√ß√µes. Crie-as via Editor no Supabase.A. Notifica√ß√£o (notify-coordinator)Este c√≥digo l√™ a sua chave RESEND_API_KEY da tabela data_metadata.import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
// Importamos o cliente do Supabase para poder ler a tabela
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  // 1. Recebe os dados do Webhook
  const payload = await req.json()
  const record = payload.record 

  // Valida√ß√£o b√°sica: s√≥ envia se estiver pendente e tiver e-mail
  if (record.status !== 'pendente' || !record.coordenador_email) {
    return new Response('Ignorado', { status: 200 })
  }

  // 2. Conecta no Supabase para buscar a API Key
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  // 3. Busca a chave na sua tabela 'data_metadata'
  const { data: keyData, error: keyError } = await supabase
    .from('data_metadata')
    .select('valor') 
    .eq('chave', 'RESEND_API_KEY')
    .single()

  if (keyError || !keyData) {
    console.error("Erro ao buscar API Key:", keyError)
    return new Response('Erro de Configura√ß√£o: API Key n√£o encontrada', { status: 500 })
  }

  const RESEND_API_KEY = keyData.valor

  // URLs REAIS que voc√™ configurou
  const approveUrl = `https://dldsocponbjthqxhmttj.supabase.co/functions/v1/approve-visit?id=${record.id}`;
  const rejectUrl = `https://dldsocponbjthqxhmttj.supabase.co/functions/v1/reject-visit?id=${record.id}`;

  // 4. Monta o HTML do E-mail
  const htmlContent = `
    <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #eee; padding: 20px; border-radius: 10px;">
      <h2 style="color: #333;">Nova Visita Recebida</h2>
      <p><strong>ID da Visita:</strong> ${record.id}</p>
      <p><strong>Observa√ß√µes:</strong> ${record.observacao || 'Nenhuma'}</p>
      
      <div style="margin-top: 30px;">
        <a href="${approveUrl}" 
           style="background-color: #28a745; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; margin-right: 10px;">
           ‚úÖ APROVAR
        </a>
        <a href="${rejectUrl}" 
           style="background-color: #dc3545; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
           ‚ùå REPROVAR
        </a>
      </div>
      <p style="font-size: 12px; color: #999; margin-top: 20px;">Este √© um e-mail autom√°tico do Dashboard de Promotores.</p>
    </div>
  `

  // 5. Envia o e-mail usando o Resend
  const res = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${RESEND_API_KEY}`,
    },
    body: JSON.stringify({
      from: 'onboarding@resend.dev',
      to: record.coordenador_email,
      subject: `Aprova√ß√£o Necess√°ria: Visita #${record.id}`,
      html: htmlContent,
    }),
  })

  const data = await res.json()
  return new Response(JSON.stringify(data), {
    headers: { 'Content-Type': 'application/json' },
  })
})
B. Aprova√ß√£o (approve-visit)import { serve } from "[https://deno.land/std@0.168.0/http/server.ts](https://deno.land/std@0.168.0/http/server.ts)"
import { createClient } from "[https://esm.sh/@supabase/supabase-js@2](https://esm.sh/@supabase/supabase-js@2)"

serve(async (req) => {
  const id = new URL(req.url).searchParams.get('id')
  const supabase = createClient(Deno.env.get('SUPABASE_URL')!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!)
  await supabase.from('visitas').update({ status: 'aprovado' }).eq('id', id)
  return new Response('<h1>Aprovado com sucesso! ‚úÖ</h1>', { headers: {'Content-Type': 'text/html'} })
})
C. Rejei√ß√£o (reject-visit)import { serve } from "[https://deno.land/std@0.168.0/http/server.ts](https://deno.land/std@0.168.0/http/server.ts)"
import { createClient } from "[https://esm.sh/@supabase/supabase-js@2](https://esm.sh/@supabase/supabase-js@2)"

serve(async (req) => {
  const id = new URL(req.url).searchParams.get('id')
  const supabase = createClient(Deno.env.get('SUPABASE_URL')!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!)
  await supabase.from('visitas').update({ status: 'rejeitado' }).eq('id', id)
  return new Response('<h1>Visita Rejeitada ‚ùå</h1>', { headers: {'Content-Type': 'text/html'} })
})
