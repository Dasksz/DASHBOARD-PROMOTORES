üöÄ Plano V11 (Final): Fun√ß√µes de Aprova√ß√£o e Reprova√ß√£o com URLs ReaisEste documento consolida a solu√ß√£o 100% interna no Supabase, agora com as suas URLs de produ√ß√£o integradas.1. Banco de Dados (Supabase)Primeiro, garantimos a tabela de visitas e a seguran√ßa da tabela de metadados.No "SQL Editor" do Supabase:-- 1. Cria a tabela de visitas (se n√£o existir)
CREATE TABLE IF NOT EXISTS public.visitas (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    id_promotor uuid REFERENCES auth.users(id) ON DELETE CASCADE, 
    id_cliente bigint, 
    
    -- Dados de Tempo e Local
    data_visita timestamp with time zone DEFAULT now(),
    checkout_at timestamp with time zone,
    latitude double precision,
    longitude double precision,
    
    -- Dados do Relat√≥rio
    status text DEFAULT 'pendente',
    respostas jsonb,
    observacao text,
    coordenador_email text 
);

-- 2. Habilita seguran√ßa (RLS) nas Visitas
ALTER TABLE public.visitas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Promotores criam visitas" ON public.visitas FOR INSERT TO authenticated WITH CHECK (auth.uid() = id_promotor);
CREATE POLICY "Promotores veem suas visitas" ON public.visitas FOR ALL TO authenticated USING (auth.uid() = id_promotor);
CREATE POLICY "Service Role Full Access" ON public.visitas FOR ALL TO service_role USING (true);

-- 3. SEGURAN√áA DA TABELA DE METADADOS (IMPORTANTE!)
-- Garante que o p√∫blico N√ÉO consiga ler sua API Key
ALTER TABLE public.data_metadata ENABLE ROW LEVEL SECURITY;

-- Remove pol√≠ticas antigas se existirem para evitar vazamento
DROP POLICY IF EXISTS "Metadados Publicos" ON public.data_metadata;

-- Cria pol√≠tica: Apenas o "Service Role" (nosso c√≥digo de servidor) pode ler essa tabela
CREATE POLICY "Apenas Servidor L√™ Metadados" ON public.data_metadata
FOR SELECT TO service_role USING (true);

-- 4. Automa√ß√£o: Buscar e-mail do coordenador
CREATE OR REPLACE FUNCTION buscar_email_coordenador()
RETURNS TRIGGER AS $$
BEGIN
  NEW.coordenador_email := (SELECT email FROM profiles WHERE eh_coordenador = true LIMIT 1);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_auto_email ON visitas;
CREATE TRIGGER trigger_auto_email
BEFORE INSERT ON visitas
FOR EACH ROW
EXECUTE FUNCTION buscar_email_coordenador();
2. Frontend: Modais (index.html)(Deve estar localizado e ser√° aberto ao clicar nos¬†clientes est√£o na rota do dia do promotor... na pagina ‚Äúroteiro‚Äù)<!-- === MODAL 1: RELAT√ìRIO DE VISITA === -->
<div id="modal-relatorio" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Relat√≥rio de Visita</h3>
            <span class="close-modal" onclick="fecharModalRelatorio()">&times;</span>
        </div>
        
        <form id="form-visita">
            <input type="hidden" id="visita-atual-id" name="visita_id">
            <p class="hint-text">üí° Dados carregados da √∫ltima visita. Altere o que mudou.</p>

            <div class="form-group">
                <label>Como est√° a g√¥ndola?</label>
                <select name="estado_gondola" required>
                    <option value="">Selecione...</option>
                    <option value="Excelente">Excelente</option>
                    <option value="Boa">Boa</option>
                    <option value="Bagun√ßada">Bagun√ßada</option>
                    <option value="Critica">Cr√≠tica</option>
                </select>
            </div>

            <div class="section-title">Elma Chips</div>
            <div class="form-group">
                <label>Tipo de Rack:</label>
                <select name="tipo_rack_elma_chips">
                    <option value="Nenhum">Nenhum</option>
                    <option value="Rack Padr√£o">Rack Padr√£o</option>
                    <option value="Ponta de G√¥ndola">Ponta de G√¥ndola</option>
                    <option value="Display de Ch√£o">Display de Ch√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tem se√ß√£o dedicada?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_secao_elma_chips" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_secao_elma_chips" value="Nao"> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea name="observacoes" rows="2" placeholder="Algo relevante?"></textarea>
            </div>

            <button type="submit" class="btn-primary full-width">Salvar Relat√≥rio</button>
        </form>
    </div>
</div>

<!-- === MODAL 2: INFORMA√á√ïES DO CLIENTE === -->
<div id="modal-info-cliente" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Sobre o Cliente</h3>
            <span class="close-modal" onclick="fecharModalInfo()">&times;</span>
        </div>
        <div id="info-cliente-conteudo">
            <p>Carregando...</p>
        </div>
        <button class="btn-secondary full-width" onclick="fecharModalInfo()" style="background:#666; margin-top:10px;">Fechar</button>
    </div>
</div>
3. Estilos: CSS (styles.css)
(Mantido igual - Adicione ao final do styles.css)

/* --- MODAIS --- */
.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(2px);
}

.modal-content {
    background: #fff;
    width: 90%;
    max-width: 400px;
    max-height: 85vh;
    overflow-y: auto;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.close-modal { font-size: 28px; cursor: pointer; color: #999; }
.hint-text { font-size: 12px; color: #666; background: #f0f8ff; padding: 8px; border-radius: 4px; margin-bottom: 10px; }

/* --- FORMUL√ÅRIOS --- */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
.form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

.radio-group { display: flex; gap: 15px; }
.radio-group label { background: #f9f9f9; padding: 8px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

/* --- BOT√ïES DE A√á√ÉO DOS CLIENTES --- */
.cliente-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
}

.btn-action {
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    color: white;
    text-align: center;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-checkin { background-color: #28a745; }
.btn-checkout { background-color: #dc3545; animation: pulse 2s infinite; }
.btn-survey { background-color: #007bff; }
.btn-info { background-color: #6c757d; }

.btn-disabled {
    background-color: #e9ecef;
    color: #999;
    cursor: not-allowed;
    border: 1px solid #ddd;
}

@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }


4. L√≥gica JavaScript (app.js)
Mantido igual - Atualize seu app.js)

// Vari√°veis Globais de Controle
let visitaAbertaId = null; 
let clienteEmVisitaId = null;

// Chame esta fun√ß√£o assim que o app iniciar
async function verificarVisitaAberta() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data } = await supabase
        .from('visitas')
        .select('id, id_cliente')
        .eq('id_promotor', user.id)
        .is('checkout_at', null)
        .maybeSingle();

    if (data) {
        visitaAbertaId = data.id;
        clienteEmVisitaId = data.id_cliente;
        localStorage.setItem('currentVisitaId', data.id);
    } else {
        visitaAbertaId = null;
        clienteEmVisitaId = null;
        localStorage.removeItem('currentVisitaId');
    }
    
    if (typeof meusClientesGlobais !== 'undefined') {
        renderClientes(meusClientesGlobais);
    }
}

// Renderiza√ß√£o Inteligente (Check-in vs Check-out)
function renderClientes(listaClientes) {
    const container = document.getElementById('lista-clientes'); 
    if (!container) return;
    container.innerHTML = '';

    listaClientes.forEach(cliente => {
        const card = document.createElement('div');
        card.className = 'card-cliente';
        
        const estouNesteCliente = (visitaAbertaId && clienteEmVisitaId === cliente.id);
        const estouEmOutroCliente = (visitaAbertaId && clienteEmVisitaId !== cliente.id);

        let botoesHTML = '';

        // 1. Bot√£o Check-in / Check-out
        if (estouNesteCliente) {
            botoesHTML += `
                <button class="btn-action btn-checkout" onclick="fazerCheckOut(${cliente.id})">
                    üõë Fazer Check-out
                </button>
            `;
        } else if (estouEmOutroCliente) {
            botoesHTML += `
                <button class="btn-action btn-disabled" onclick="alert('Voc√™ precisa finalizar a visita atual antes!')">
                    üîí Check-in Bloqueado
                </button>
            `;
        } else {
            botoesHTML += `
                <button class="btn-action btn-checkin" onclick="fazerCheckIn(${cliente.id})">
                    üìç Fazer Check-in
                </button>
            `;
        }

        // 2. Bot√£o Pesquisa
        if (estouNesteCliente) {
            botoesHTML += `
                <button class="btn-action btn-survey" onclick="abrirModalRelatorio()">
                    üìù Responder Pesquisa
                </button>
            `;
        }

        // 3. Bot√£o Informa√ß√µes
        botoesHTML += `
            <button class="btn-action btn-info" onclick="verInfoCliente(${cliente.id})">
                ‚ÑπÔ∏è Informa√ß√µes
            </button>
        `;

        card.innerHTML = `
            <div onclick="toggleAcoes(${cliente.id})">
                <h3>${cliente.nome}</h3>
                <p>${cliente.endereco || 'Endere√ßo n√£o cadastrado'}</p>
            </div>
            <div id="acoes-${cliente.id}" class="cliente-actions" style="display:none;">
                ${botoesHTML}
            </div>
        `;
        
        container.appendChild(card);
    });
}

window.toggleAcoes = function(id) {
    const div = document.getElementById(`acoes-${id}`);
    if (div) div.style.display = div.style.display === 'none' ? 'flex' : 'none';
}

// A√ß√µes de Check-in/out
async function fazerCheckIn(clienteId) {
    if (visitaAbertaId) return alert("Finalize a visita anterior primeiro!");

    const { data: { user } } = await supabase.auth.getUser();
    
    navigator.geolocation.getCurrentPosition(async (position) => {
        const { latitude, longitude } = position.coords;

        const { data, error } = await supabase
            .from('visitas')
            .insert([{ 
                id_promotor: user.id, 
                id_cliente: clienteId, 
                data_visita: new Date(),
                latitude: latitude,
                longitude: longitude,
                status: 'pendente'
            }])
            .select()
            .single();

        if (error) {
            console.error(error);
            alert('Erro ao iniciar visita.');
        } else {
            visitaAbertaId = data.id;
            clienteEmVisitaId = clienteId;
            localStorage.setItem('currentVisitaId', data.id);
            alert("Check-in realizado! üïí");
            renderClientes(meusClientesGlobais); 
        }
    }, () => alert("Permita a localiza√ß√£o para fazer check-in."));
}

async function fazerCheckOut(clienteId) {
    if (!confirm("Tem certeza que deseja sair?")) return;

    const { error } = await supabase
        .from('visitas')
        .update({ checkout_at: new Date() })
        .eq('id', visitaAbertaId);

    if (error) {
        alert("Erro ao finalizar.");
    } else {
        alert("Visita finalizada! ‚úÖ");
        visitaAbertaId = null;
        clienteEmVisitaId = null;
        localStorage.removeItem('currentVisitaId');
        renderClientes(meusClientesGlobais); 
    }
}

// Modal Pesquisa
window.abrirModalRelatorio = async function() {
    if (!visitaAbertaId) return alert("Fa√ßa Check-in primeiro!");

    document.body.style.cursor = 'wait';
    const form = document.getElementById('form-visita');
    form.reset();

    try {
        const { data } = await supabase
            .from('visitas')
            .select('respostas')
            .eq('id_cliente', clienteEmVisitaId)
            .not('respostas', 'is', null)
            .neq('id', visitaAbertaId) 
            .order('data_visita', { ascending: false })
            .limit(1)
            .maybeSingle();

        if (data && data.respostas) {
            Object.keys(data.respostas).forEach(key => {
                const el = form.elements[key];
                if (el) {
                    if (el instanceof RadioNodeList) el.value = data.respostas[key];
                    else if (el.type === 'checkbox') el.checked = !!data.respostas[key];
                    else el.value = data.respostas[key];
                }
            });
        }
    } catch (e) {
        console.log("Nenhum hist√≥rico encontrado ou erro:", e);
    } finally {
        document.body.style.cursor = 'default';
        document.getElementById('visita-atual-id').value = visitaAbertaId;
        document.getElementById('modal-relatorio').style.display = 'flex';
    }
}

document.getElementById('form-visita').addEventListener('submit', async function(e) {
    e.preventDefault();
    const visitaId = document.getElementById('visita-atual-id').value;
    const formData = new FormData(e.target);
    const respostas = Object.fromEntries(formData.entries());

    const { error } = await supabase
        .from('visitas')
        .update({ 
            respostas: respostas,
            observacao: respostas.observacoes 
        })
        .eq('id', visitaId);

    if (!error) {
        alert("Relat√≥rio salvo! O coordenador ser√° notificado.");
        fecharModalRelatorio();
    } else {
        alert("Erro ao salvar.");
    }
});

window.fecharModalRelatorio = () => document.getElementById('modal-relatorio').style.display = 'none';
window.fecharModalInfo = () => document.getElementById('modal-info-cliente').style.display = 'none';

window.verInfoCliente = function(id) {
    const cliente = meusClientesGlobais.find(c => c.id === id);
    if (cliente) {
        document.getElementById('info-cliente-conteudo').innerHTML = `
            <p><strong>Nome:</strong> ${cliente.nome}</p>
            <p><strong>CNPJ:</strong> ${cliente.cnpj || '-'}</p>
            <p><strong>Endere√ßo:</strong> ${cliente.endereco || '-'}</p>
        `;
        document.getElementById('modal-info-cliente').style.display = 'flex';
    }
}

5. Fun√ß√£o de Notifica√ß√£o (notify-coordinator)
   import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
// Importamos o cliente do Supabase para poder ler a tabela
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  // 1. Recebe os dados do Webhook
  const payload = await req.json()
  const record = payload.record 

  // Valida√ß√£o b√°sica: s√≥ envia se estiver pendente e tiver e-mail
  if (record.status !== 'pendente' || !record.coordenador_email) {
    return new Response('Ignorado', { status: 200 })
  }

  // 2. Conecta no Supabase para buscar a API Key
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  // 3. Busca a chave na sua tabela 'data_metadata'
  const { data: keyData, error: keyError } = await supabase
    .from('data_metadata')
    .select('valor') 
    .eq('chave', 'RESEND_API_KEY')
    .single()

  if (keyError || !keyData) {
    console.error("Erro ao buscar API Key:", keyError)
    return new Response('Erro de Configura√ß√£o: API Key n√£o encontrada', { status: 500 })
  }

  const RESEND_API_KEY = keyData.valor

  // URLs REAIS que voc√™ configurou
  const approveUrl = `https://dldsocponbjthqxhmttj.supabase.co/functions/v1/approve-visit?id=${record.id}`;
  const rejectUrl = `https://dldsocponbjthqxhmttj.supabase.co/functions/v1/reject-visit?id=${record.id}`;

  // 4. Monta o HTML do E-mail
  const htmlContent = `
    <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #eee; padding: 20px; border-radius: 10px;">
      <h2 style="color: #333;">Nova Visita Recebida</h2>
      <p><strong>ID da Visita:</strong> ${record.id}</p>
      <p><strong>Observa√ß√µes:</strong> ${record.observacao || 'Nenhuma'}</p>
      
      <div style="margin-top: 30px;">
        <a href="${approveUrl}" 
           style="background-color: #28a745; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; margin-right: 10px;">
           ‚úÖ APROVAR
        </a>
        <a href="${rejectUrl}" 
           style="background-color: #dc3545; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
           ‚ùå REPROVAR
        </a>
      </div>
      <p style="font-size: 12px; color: #999; margin-top: 20px;">Este √© um e-mail autom√°tico do Dashboard de Promotores.</p>
    </div>
  `

  // 5. Envia o e-mail usando o Resend
  const res = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${RESEND_API_KEY}`,
    },
    body: JSON.stringify({
      from: 'onboarding@resend.dev',
      to: record.coordenador_email,
      subject: `Aprova√ß√£o Necess√°ria: Visita #${record.id}`,
      html: htmlContent,
    }),
  })

  const data = await res.json()
  return new Response(JSON.stringify(data), {
    headers: { 'Content-Type': 'application/json' },
  })
})
6. Criando as Fun√ß√µes de RespostaImplemente estas fun√ß√µes para que os links acima funcionem.Fun√ß√£o A: approve-visitimport { serve } from "[https://deno.land/std@0.168.0/http/server.ts](https://deno.land/std@0.168.0/http/server.ts)"
import { createClient } from "[https://esm.sh/@supabase/supabase-js@2](https://esm.sh/@supabase/supabase-js@2)"

serve(async (req) => {
  const url = new URL(req.url)
  const id = url.searchParams.get('id')
  if (!id) return new Response("ID inv√°lido", { status: 400 })

  const supabase = createClient(Deno.env.get('SUPABASE_URL') ?? '', Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '')
  await supabase.from('visitas').update({ status: 'aprovado' }).eq('id', id)

  return new Response(`<html><body style="font-family:sans-serif;text-align:center;padding:50px;"><h1 style="color:green;">Visita Aprovada! ‚úÖ</h1></body></html>`, { headers: { "Content-Type": "text/html" } })
})
Fun√ß√£o B: reject-visitimport { serve } from "[https://deno.land/std@0.168.0/http/server.ts](https://deno.land/std@0.168.0/http/server.ts)"
import { createClient } from "[https://esm.sh/@supabase/supabase-js@2](https://esm.sh/@supabase/supabase-js@2)"

serve(async (req) => {
  const url = new URL(req.url)
  const id = url.searchParams.get('id')
  if (!id) return new Response("ID inv√°lido", { status: 400 })

  const supabase = createClient(Deno.env.get('SUPABASE_URL') ?? '', Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '')
  await supabase.from('visitas').update({ status: 'rejeitado' }).eq('id', id)

  return new Response(`<html><body style="font-family:sans-serif;text-align:center;padding:50px;"><h1 style="color:red;">Visita Reprovada ‚ùå</h1></body></html>`, { headers: { "Content-Type": "text/html" } })
})
