üöÄ Plano de Implementa√ß√£o: Relat√≥rio com Aprova√ß√£o (Adaptado ao C√≥digo Existente)Este plano foi ajustado especificamente para a estrutura de arquivos do DASHBOARD-PROMOTORES que voc√™ enviou.1. Banco de Dados (Supabase)Como voc√™ confirmou que a tabela visitas ainda n√£o existe, precisamos cri√°-la do zero para guardar os check-ins e os relat√≥rios.Copie e cole este c√≥digo no "SQL Editor" do seu painel Supabase:-- Cria a tabela de visitas do zero
CREATE TABLE public.visitas (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    
    -- Quem fez a visita (ajuste se seu ID de promotor n√£o for UUID)
    id_promotor uuid REFERENCES auth.users(id) ON DELETE CASCADE, 
    
    -- Qual cliente foi visitado (assumindo que seja um ID num√©rico)
    id_cliente bigint, 
    
    -- Dados da visita
    data_visita timestamp with time zone DEFAULT now(),
    latitude double precision,
    longitude double precision,
    
    -- Campos do Fluxo de Aprova√ß√£o
    status text DEFAULT 'pendente', -- pendente, aprovado, rejeitado
    respostas jsonb, -- Aqui ficam as respostas do formul√°rio (g√¥ndola, ruptura, etc)
    observacao text,
    coordenador_email text -- Opcional
);

-- Habilita seguran√ßa (RLS)
ALTER TABLE public.visitas ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica 1: Promotores podem criar visitas (INSERT)
CREATE POLICY "Promotores podem criar visitas" 
ON public.visitas FOR INSERT 
TO authenticated 
WITH CHECK (auth.uid() = id_promotor);

-- Pol√≠tica 2: Promotores podem ver e editar suas pr√≥prias visitas
CREATE POLICY "Promotores veem suas proprias visitas" 
ON public.visitas FOR ALL 
TO authenticated 
USING (auth.uid() = id_promotor);
2. Frontend: O Modal do Formul√°rio (index.html)Vamos adicionar o HTML do formul√°rio como um "Modal" oculto no final do seu index.html, logo antes do fechamento da tag </body>. Adicionei todas as perguntas novas sobre a Elma Chips e Correlatos.Adicione este c√≥digo no final do index.html:<!-- ... restante do seu c√≥digo ... -->

<!-- MODAL DE RELAT√ìRIO -->
<div id="modal-relatorio" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Relat√≥rio de Visita</h3>
            <span class="close-modal" onclick="fecharModalRelatorio()">&times;</span>
        </div>
        
        <form id="form-visita">
            <!-- Campo oculto para saber qual visita estamos atualizando -->
            <input type="hidden" id="visita-atual-id" name="visita_id">

            <!-- Perguntas Gerais -->
            <div class="form-group">
                <label>Como est√° a g√¥ndola?</label>
                <select name="estado_gondola" required>
                    <option value="">Selecione...</option>
                    <option value="Excelente">Excelente</option>
                    <option value="Boa">Boa</option>
                    <option value="Bagun√ßada">Bagun√ßada</option>
                    <option value="Critica">Cr√≠tica</option>
                </select>
            </div>

            <!-- Perguntas Elma Chips -->
            <div class="form-group">
                <label>Qual tipo de Rack Elma Chips no local?</label>
                <select name="tipo_rack_elma_chips">
                    <option value="Nenhum">Nenhum</option>
                    <option value="Rack Padr√£o">Rack Padr√£o</option>
                    <option value="Ponta de G√¥ndola">Ponta de G√¥ndola</option>
                    <option value="Display de Ch√£o">Display de Ch√£o</option>
                    <option value="Clip Strip">Clip Strip</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tem se√ß√£o de Elma Chips?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_secao_elma_chips" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_secao_elma_chips" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Tem 50% do Checkout?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_50_checkout" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_50_checkout" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Ilha de Elma Chips na loja?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_ilha_elma_chips" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_ilha_elma_chips" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Tem Ponto Extra na loja?</label>
                <div class="radio-group">
                    <label><input type="radio" name="tem_ponto_extra" value="Sim"> Sim</label>
                    <label><input type="radio" name="tem_ponto_extra" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <p style="font-weight: bold; margin-bottom: 10px; color: #666;">Correlatos (Cross-merchandising)</p>

            <div class="form-group">
                <label>Tem Correlatos na Se√ß√£o de Bebidas?</label>
                <div class="radio-group">
                    <label><input type="radio" name="correlatos_bebidas" value="Sim"> Sim</label>
                    <label><input type="radio" name="correlatos_bebidas" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Tem Correlatos na Se√ß√£o de Molho?</label>
                <div class="radio-group">
                    <label><input type="radio" name="correlatos_molho" value="Sim"> Sim</label>
                    <label><input type="radio" name="correlatos_molho" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Tem Correlatos na Se√ß√£o de Biscoito?</label>
                <div class="radio-group">
                    <label><input type="radio" name="correlatos_biscoito" value="Sim"> Sim</label>
                    <label><input type="radio" name="correlatos_biscoito" value="Nao" checked> N√£o</label>
                </div>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes Gerais:</label>
                <textarea name="observacoes" rows="3" placeholder="Digite aqui..."></textarea>
            </div>

            <button type="submit" class="btn-primary full-width">Enviar para Aprova√ß√£o</button>
        </form>
    </div>
</div>

<!-- Fim do Body / Scripts... -->
3. Estilos: Deixando Bonito (styles.css)Adicione este CSS ao final do seu arquivo styles.css. Ele garante que o modal fique centralizado e bonito tanto no celular quanto no computador.Adicione ao final do styles.css:/* --- MODAL STYLES --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(3px);
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 400px;
    max-height: 90vh; /* Limita altura para n√£o estourar a tela */
    overflow-y: auto; /* Adiciona scroll se tiver muitas perguntas */
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.close-modal {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.form-group select, 
.form-group textarea, 
.form-group input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px; /* Evita zoom no iPhone */
}

/* Ajuste para o radio group ficar lado a lado */
.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 5px;
}

.radio-group label {
    display: flex;
    align-items: center;
    font-weight: normal;
    cursor: pointer;
}

.radio-group input {
    margin-right: 5px;
    transform: scale(1.2);
}

.full-width {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    background-color: #28a745; /* Cor verde para destaque */
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}
4. L√≥gica: JavaScript (app.js)Aqui faremos a conex√£o. Precisamos de 3 partes no seu c√≥digo JS:Parte A: Criar a visita no banco (Check-in)Atualize sua fun√ß√£o checkIn (ou crie se n√£o tiver) para salvar no banco assim que o promotor chegar no local.// Vari√°vel global para saber qual visita est√° rolando
let currentVisitaId = localStorage.getItem('currentVisitaId');

async function checkIn(clienteId) {
    // Pega o usu√°rio logado (ajuste conforme sua l√≥gica de auth)
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
        alert("Erro: Usu√°rio n√£o logado!");
        return;
    }

    // Tenta pegar localiza√ß√£o (opcional)
    navigator.geolocation.getCurrentPosition(async (position) => {
        const { latitude, longitude } = position.coords;

        const { data, error } = await supabase
            .from('visitas')
            .insert([{ 
                id_promotor: user.id, 
                id_cliente: clienteId, 
                data_visita: new Date(),
                latitude: latitude,
                longitude: longitude,
                status: 'pendente'
            }])
            .select(); // Retorna o dado criado

        if (error) {
            console.error('Erro no check-in:', error);
            alert('Erro ao fazer check-in.');
        } else {
            // Salva o ID da visita para usar no formul√°rio depois
            currentVisitaId = data[0].id;
            localStorage.setItem('currentVisitaId', currentVisitaId);
            
            alert("Check-in realizado! Lembre-se de preencher o formul√°rio.");
            
            // Aqui voc√™ pode atualizar a interface (ex: mudar bot√£o para 'Relat√≥rio')
            renderClientes(); 
        }
    }, (err) => {
        alert("Precisamos da sua localiza√ß√£o para o check-in.");
    });
}
Parte B: Abrir e Fechar ModalAdicione essas fun√ß√µes no final do seu app.js ou onde ficam seus helpers.window.abrirModalRelatorio = function() {
    // Verifica se tem uma visita em andamento
    const visitaId = localStorage.getItem('currentVisitaId');
    
    if(!visitaId) {
        alert("Voc√™ precisa fazer Check-in antes de preencher o relat√≥rio!");
        return;
    }
    
    // Preenche o campo oculto com o ID
    document.getElementById('visita-atual-id').value = visitaId;
    document.getElementById('modal-relatorio').style.display = 'flex';
}

window.fecharModalRelatorio = function() {
    document.getElementById('modal-relatorio').style.display = 'none';
}
Parte C: Enviar o Formul√°rioEssa fun√ß√£o pega os dados do modal e atualiza a visita que criamos no check-in.document.getElementById('form-visita').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const visitaId = document.getElementById('visita-atual-id').value;
    const formData = new FormData(e.target);
    
    // Transforma os dados do form em um objeto simples
    const respostas = Object.fromEntries(formData.entries());

    const btnSubmit = e.target.querySelector('button[type="submit"]');
    btnSubmit.innerText = "Enviando...";
    btnSubmit.disabled = true;

    try {
        // Atualiza a visita existente
        const { error } = await supabase
            .from('visitas')
            .update({
                respostas: respostas, // Salva o JSON com as respostas
                observacao: respostas.observacoes,
                status: 'pendente' // Garante que est√° pendente para o coordenador ver
            })
            .eq('id', visitaId);

        if (error) throw error;

        alert("Relat√≥rio enviado com sucesso! Aguardando aprova√ß√£o.");
        
        // Limpeza
        fecharModalRelatorio();
        e.target.reset();
        localStorage.removeItem('currentVisitaId'); // Limpa a visita atual
        currentVisitaId = null;
        renderClientes(); // Atualiza a tela

    } catch (error) {
        console.error("Erro ao enviar:", error);
        alert("Erro ao enviar relat√≥rio. Tente novamente.");
    } finally {
        btnSubmit.innerText = "Enviar para Aprova√ß√£o";
        btnSubmit.disabled = false;
    }
});
5. Como testarRode o SQL no Supabase.Atualize o index.html e styles.css.Atualize o app.js.No seu site, fa√ßa login, escolha um cliente e clique no bot√£o que chama a fun√ß√£o checkIn(id_do_cliente).Veja se apareceu uma linha nova na tabela visitas no Supabase.Abra o modal (abrirModalRelatorio()), preencha e envie.Verifique se a coluna respostas no Supabase foi preenchida com o JSON dos dados.
